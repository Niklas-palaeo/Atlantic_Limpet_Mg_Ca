---
title: "Interspecies comparisons of Mg/Ca ratios in limpet shells"
author:
  - name: Niklas Hausmann
    affiliations:
      - name: Leibniz Zentrum für Archäologie
        address: Ludwig-Lindenschmit-Forum 1
        city: Mainz
        country: Germany
        postal-code: 55116
    orcid: 0000–0002–4381–8334
    email: niklas@palaeo.eu
    attributes:
      corresponding: true
  - name: Donna Surge
    affiliations:
      - name: University of North Carolina
        address: 104 South Road, 225 Geology Building
        city: Chapel Hill, NC
        country: US
        postal-code: 27599-3315
  - name: Francisco Zangrando
    affiliations:
      - name: CONICET (Consejo Nacional de Investigaciones Científicas y Técnicas)
        address: Avenida Maipú 305
        city: Ushuaia
        country: Argentina
        postal-code: V9410BJA
  - name: Angelica Tivoli
    affiliations:
      - name: CONICET (Consejo Nacional de Investigaciones Científicas y Técnicas)
        address: Avenida Maipú 305
        city: Ushuaia
        country: Argentina
        postal-code: V9410BJA
  - name: Ivan Briz-Godino
    affiliations:
      - name: 
        address: 
        city: 
        country: Spain
        postal-code: 
abstract: |
  This study provides a short reassessment of the use of Magnesium to Calcium (Mg/Ca) ratios in Atlantic limpet shells to determine past sea surface temperatures. While *Patella vulgata* along the Spanish shoreline has since then repeatedly produced reliable correlations between sea surface temperature and Mg/Ca ratios, this is not the case for other patelloid species. *Patella vulgata* and *Nacella deaureata* have been studied using Mg/Ca with mixed or contrary results. In this study, we present elemental maps of various such species together with stable oxygen isotope values for some of the specimens. Our dataset also includes specimens that were previously unsuccessful in providing significant correlations between δ^18^O and Mg/Ca ratios. By reassessing these previous specimens and including a wider range of  modern and archaeological samples from three patelloid species (*P. vulgata*, *N. deaureata*, and *N. magellanica*) we further add to the growing set of evidence for the reliable use of Mg/Ca ratios to detect palaeotemperature change and serve as a means to determine ontogenetic age and season of capture as well as to reveal locations of interest within the growth record (i.e. annual temperature minima and maxima) for the targeted analysis using δ^18^O or clumped oxygen isotope analysis.
keywords: 
  - Sclerochronology
  - Limpets
  - Elemental Ratio
  - Mg/Ca
date: last-modified
bibliography: bibliography.bib
format:
  elsevier-pdf:
    keep-tex: true
    journal:
      name: Palaeo^3^
      formatting: preprint
      model: 3p
      cite-style: authoryear
output:
  units: cm
---

# Introduction {#Introduction}

```{r Library and datasets}
#| echo: FALSE
#| message: FALSE
#| warning: FALSE

knitr::opts_chunk$set(echo=FALSE,message = FALSE,warning = FALSE)
# Packages
  pacman::p_load(
    here,
    janitor,
    tidyverse,
    cowplot,ggx,ggpubr,
    patchwork,
    RColorBrewer) 
  
  theme_set(theme_cowplot())

# Scripts
# source("DTW_Script.R")
source("DTW_Script-update.R")

  
# Files  


D18O <- read_csv(here("data","D18O.csv"))
MgCa <- read_csv(here("data","MgCa.csv"))

Ferguson_data <- read_csv(here("data","Ferguson-data.csv")) %>% 
  na.omit()

# # Check overlaps
# # Find common sample IDs
# intersect(MgCa$sampleID, D18O$sampleID)
# 
# # Find sample IDs only in MgCa
# setdiff(MgCa$sampleID, D18O$sampleID)
# 
# # Find sample IDs only in D18O
# setdiff(D18O$sampleID, MgCa$sampleID)

```

Limpet shells are commonly found within archaeological sites and and past shorelines due to their robust carbonate structure and the long-term use of limpets as a marine food source. They have successfully been studied in the past in the context of coastal subsistence economies, site occupation on seasonal [@shackleton1973; @Parker2018-wf; @Bosch2018-ud] or long-term scale [@Ortiz2015-mr], as well as palaeotemperature [@Fenger2007-gf; @Surge2012-ba; @Wang2012-ee; @Colonese2012-ct; @Ferguson2011-zl]. Determining past sea surface temperature (SST) change largely relies on the measurement of δ^18^O-values within the calcitic parts of the shell, but attempts have been made to also use elemental ratios, such as magnesium to calcium (Mg/Ca), to have an alternative measure, that potentially provides a more accurate SST estimate than δ^18^O-values, which are also affected by changes in salinity. In addition, the data acquisition of elemental ratios — either through laser-ablation-isotope-ratio-mass-spectrometry (LA-ICP-MS) or laser induced breakdown spectroscopy (LIBS), can be much faster and cost-effective, increasing the number of specimens that can be studied overall [@Durham2017-fh; @Hausmann2023-ih].

Problematically, links between Mg/Ca ratios and SST changes in limpets have also been shown to be unreliable [@Graniero2015-zv] and even where they were successful, anomalous patterns in some specimens had to be filtered out, reducing the overall robustness of the results of those successful studies [@Ferguson2011-zl].

While recent research particularly of *Patella* sp. in the Mediterranean and Southwest Europe have provided promising results [@Hausmann2019-fi; @Garcia-Escarzaga2015-jc; @Garcia-Escarzaga2018-nf]. There remains unclarity for Atlantic limpet species, particularly since it was last shown here, that they are not reliable recorders of palaeotemperature [@Graniero2015-zv].

# Materials and Methods {#Methods}

## Limpet specimens

### Modern specimens

The analysed specimens, their origin and studies with background information can be found in Table 1.

| Context        | Study              | Species          | Location                                          | Sample ID     | Previous analyses                                           |
|------------|------------|------------|------------|------------|------------|
| Modern         | [@Nicastro2020-ih] | *N. deaureata*   | Bahía Cambaceres Exterior - Tierra del Fuego (AR) | ND-1016-3     | Stable oxygen and carbon isotope analysis                   |
|                |                    |                  |                                                   | ND-1016-4     |                                                             |
|                |                    | *N. magellanica* |                                                   | NM-1016-1     |                                                             |
|                |                    |                  |                                                   | NM-1016-3     |                                                             |
|                | [@Graniero2017-io] | *P. vulgata*     | Rack Wick Bay - Westray (UK)                      | ORK-LT5       | Stable oxygen and carbon isotope analysis; Mg, Li, Sr, Ca,. |
| Archaeological | [@Surge2012-ba]    | *P. vulgata*     | Rack Wick Bay - Westray (UK)                      | QG1-7188-1    | Stable oxygen and carbon isotope analysis                   |
|                |                    |                  |                                                   | QG1-7189-2    |                                                             |
|                |                    |                  |                                                   | QG2-1061-1    |                                                             |
|                |                    |                  |                                                   | QG2-1064-1    |                                                             |
|                |                    |                  |                                                   | QG2-7180-1    |                                                             |
|                |                    |                  |                                                   | QG2-7180-2    |                                                             |
|                |                    |                  |                                                   | QG1-7246-1    |                                                             |
|                | This study         | *N. magellanica* | Heshkaia 35                                       | Heshkaia_35-1 | *none*                                                      |
|                |                    | *N. deaureata*   |                                                   | Heshkaia_35-2 |                                                             |
|                |                    | *N. deaureata*   |                                                   | Heshkaia_35-3 |                                                             |
|                |                    | *N. magellanica* |                                                   | Heshkaia_35-4 |                                                             |
|                |                    | *N. magellanica* |                                                   | Heshkaia_35-5 |                                                             |
|                |                    | *N. magellanica* |                                                   | Heshkaia_35-6 |                                                             |
|                |                    | *N. magellanica* |                                                   | Heshkaia_35-7 |                                                             |
|                |                    | *N. deaureata*   |                                                   | Heshkaia_35-8 |                                                             |
|                |                    | *N. magellanica* |                                                   | Heshkaia_35-9 |                                                             |

: Table 1 Overview of the modern and archaeological limpet specimens analysed in this study {#tab:specimens}

### Archaeological specimens

## Oxygen isotopes

## Mg/Ca ratios

# Results {#Results}

## Patella vulgata

## Nacella deaureata

## Nacella magellanica

```{r DTW Analysis}

Samples <- unique(MgCa$sampleID)

# Initialize an empty list to store the results of shell_dtw for each sample
dtw_results <- list()

Corr_data <- tibble()

# sample <- Samples[12]

for (sample in Samples) {
  temp_D18O <- D18O %>% 
    filter(sampleID == sample) %>% 
    select(d18O) %>% 
    rename(d18o = d18O) %>% 
    mutate(sample_seq = row_number()) 

  temp_MgCa <- MgCa %>% 
    filter(sampleID == sample) %>% 
    filter(!(sampleID=="ND-1016-4"&dist<0.3)) %>% 

    select(mg_ca) %>% 
    mutate(sample_seq = row_number())

  # Apply shell_dtw to the temp dataframes and store the result in the list
  dtw_results[[sample]] <- shell_dtw_data(temp_D18O, temp_MgCa)
  
   # Add the sampleID column to temp_data
  temp_data <- dtw_results[[sample]]$data %>% 
    mutate(sampleID = sample)
  
  
  # Append temp_data to Corr_data
  Corr_data <- bind_rows(Corr_data, temp_data)
}


```

# 

```{r Correlation Graphs }
#| fig-cap: Correlation graphs for all specimens
#| fig-height: 20
#| fig-width: 10


P_all <- Corr_data %>% 
  pivot_wider(values_from = "value",names_from = "proxy") %>% 
  mutate(region = substr(sampleID, 1, 1)) %>% 
  ggplot()+
  aes(d18o,mg_ca,col=sampleID)+
  geom_point(show.legend = FALSE)+
  labs(x=expression("‰ δ" ^ "18" * "O [VPDB]"),y="Mg/Ca intensity ratio")+
  stat_smooth(aes(fill = sampleID,col=sampleID), method = "lm", formula = y~x,show.legend = FALSE) +
  # stat_regline_equation(label.x = 2, #label.y = 32
  #   aes(label =  paste(after_stat(eq.label), after_stat(adj.rr.label), sep = "~~~~")),
  #   formula = y~x
  # ) +
  scale_colour_manual(values = c( "#33a02c","#2ecc71", "#ffc100", "#f39c12", "#007f7f", "#1f78b4", "#99d8c9", "#542788","black", "#d73027", "#EC7063","pink1")) +
scale_fill_manual(values = c( "#33a02c","#2ecc71", "#ffc100", "#f39c12", "#007f7f", "#1f78b4", "#99d8c9", "#542788","black", "#d73027", "#EC7063","pink1"))#+
  # facet_wrap(~region,ncol=2,scales = "free")


# Expanded colour palette with 6 additional colours
# Updated colour palette with 4 new replacements for the last colours
# Refined colour palette with 3 additional colours
# c("#007f7f", "#d73027", "#ffc100", "black", "#1a9850", "#542788", "#3288bd", "#99d8c9")


P_individual <- P_all+ylim(0,0.8)+
  facet_wrap(~sampleID,ncol=3)+#ylim(0.15,NA)+
  ggpubr::stat_regline_equation(label.x = 0.5, label.y = 0.65,
    aes(label =  paste(after_stat(eq.label), after_stat(adj.rr.label), sep = "~~~~")),show.legend = FALSE,
    formula = y~x
  )+
  theme(
    strip.background = element_rect(fill = "white", colour = NA),
    strip.text = element_text(colour = "black"),
    panel.border = element_rect(colour="black")
  )


P_all/P_individual+plot_layout(heights = c(0.5,0.5))


```

# Discussion

## Other correlations

```{r Ferguson Data}
#| fig-cap: Correlation graphs for Ferguson et al. specimens
#| fig-height: 20
#| fig-width: 10

Ferg_all <-
  Ferguson_data %>% 
  ggplot()+
  aes(d18o,mg_ca,col=shell)+
  geom_point(show.legend = FALSE)+
  labs(x=expression("‰ δ" ^ "18" * "O [VPDB]"),y="Mg/Ca intensity ratio")+
  stat_smooth(aes(fill = shell,col=shell), method = "lm", formula = y~x,show.legend = FALSE) +
  # stat_regline_equation(label.x = 2, #label.y = 32
  #   aes(label =  paste(after_stat(eq.label), after_stat(adj.rr.label), sep = "~~~~")),
  #   formula = y~x
  # ) +
  scale_colour_manual(values = c(  "#EC7063", "#007f7f", "#1f78b4", "#542788","black", "#d73027", "#EC7063")) +
scale_fill_manual(values = c(  "#EC7063", "#007f7f", "#1f78b4", "#542788","black", "#d73027", "#EC7063"))


# Expanded colour palette with 6 additional colours
# Updated colour palette with 4 new replacements for the last colours
# Refined colour palette with 3 additional colours
# c("#007f7f", "#d73027", "#ffc100", "black", "#1a9850", "#542788", "#3288bd", "#99d8c9")


Ferg_individual <- Ferg_all+
  facet_wrap(~shell,ncol=2)+#ylim(0.15,NA)+
  ggpubr::stat_regline_equation(label.x = 1, label.y = 26,
    aes(label =  paste(after_stat(eq.label), after_stat(adj.rr.label), sep = "~~~~")),show.legend = FALSE,
    formula = y~x
  )+
  theme(
    strip.background = element_rect(fill = "white", colour = NA),
    strip.text = element_text(colour = "black"),
    panel.border = element_rect(colour="black")
  )


Ferg_all/Ferg_individual+plot_layout(heights = c(0.5,0.5))


```

| Species       | Locality       | Specimen | Correlation R^2^        | Study                             |
|---------------|---------------|---------------|---------------|---------------|
| *P. depressa* | Northern Spain | LAN541   | 0.87                    | [@garcía-escárzaga2021]           |
|               |                | LAN545   | 0.86                    |                                   |
|               |                | LAN554   | 0.78                    |                                   |
|               |                | LAN559   | 0.82                    |                                   |
| *P. caerulea* | Croatia        | ISTPC1   | 0.9                     | [@Hausmann2019-fi]                |
|               |                | ISTPC2   | 0.84                    |                                   |
|               | Crete          | AF1911A  | 0.91[^1]                |                                   |
|               |                | AF3003A  | 0.92[^2]                |                                   |
|               | Israel         | AKKPC2   | 0.96                    |                                   |
|               |                | AKKPC3   | 0.89                    |                                   |
|               |                | FRMPC1   | 0.84                    |                                   |
|               |                | FRMPC2   | 0.96                    |                                   |
|               | Libya          | MO31A    | 0.83                    |                                   |
|               |                | MP64A    | 0.33                    |                                   |
|               |                | MP67A    | 0.96                    |                                   |
|               |                | MP68A    | 0.81                    |                                   |
|               | Malta          | MA10     | 0.82                    |                                   |
|               | Tunisia        | TUNPC1   | 0.81                    |                                   |
|               |                | TUNPC2   | 0.78                    |                                   |
|               | Turkey         | ANTPC1   | 0.95                    |                                   |
|               |                | ANTPC2   | 0.93                    |                                   |
|               |                | KIZPC1   | 0.94                    |                                   |
|               |                | KIZPC2   | 0.86                    |                                   |
| *P. rustica*  | Gibraltar      | JL1      | 0.02                    | [@Ferguson2011-zl]                |
|               |                | JL2      | 0.8 (0.79)              |                                   |
| *P. caerulea* | Gibraltar      | JM00     | 0.69 (0.79)             |                                   |
|               |                | JM30     | 0.83 (0.79)             |                                   |
| *P. vulgata*  | Orkney         | ORK-LT5  | not reported, here 0.88 | [@Graniero2017-io] and this study |
|               |                |          |                         |                                   |
|               |                |          |                         |                                   |
|               |                |          |                         |                                   |

: Table 2: Overview of comparative correlations {#tab:correlations}

[^1]: SST only, no other geochemical data available

[^2]: SST only, no geochemical data available

## Comparison of ORK-LT5

```{r}

P1 <-
  MgCa %>% 
  filter(sampleID=="ORK_LT5") %>% 
  # filter(std<0.1) %>% 
  # filter(mg_ca<0.7) %>% 
  # filter(dist<20) %>% 
ggplot()+
  aes(dist,mg_ca)+
  geom_path(col="firebrick")+
  # xlim(0,10)+
  facet_wrap(~sampleID,scales = "free",nrow=1)

P2 <-
  D18O %>% 
  filter(sampleID=="ORK_LT5") %>% 
  ggplot()+
  aes(dist,d18O)+
  geom_path(col="cornflowerblue")+
  scale_y_reverse()+
  facet_wrap(~sampleID,scales = "free",nrow=1)

plot_compare <- P1/P2

plot_compare

```

```{r subsample}


# Function to create the desired subsampled tibble
subsample_data <- function(data, window_size = 0.05, step_size = 0.15) {
  max_dist <- max(data$dist)
  subsample_intervals <- seq(0, max_dist, by = step_size)
  
  subsampled_data <- subsample_intervals %>%
    purrr::map_df(~ {
      window_start <- .x
      window_end <- .x + window_size
      
      data_in_window <- data %>%
        filter(dist >= window_start & dist < window_end)
      
      if (nrow(data_in_window) > 0) {
        summarised_data <- data_in_window %>%
          summarise(across(c(x, y, z, mg_ca, std, relstd, dist), mean, .names = "mean_{.col}"))
        summarised_data <- summarised_data %>%
          mutate(window_start = window_start, window_end = window_end)
        return(summarised_data)
      } else {
        return(tibble())
      }
    })
  
  return(subsampled_data)
}

# Apply the function to your data
MgCa_filtered <- MgCa %>%
  filter(sampleID == "ORK_LT5")

MgCa_subsampled_150 <- subsample_data(MgCa_filtered,step_size = 0.15)

MgCa_subsampled_300 <-  subsample_data(MgCa_filtered,step_size = 0.30)

P3.1 <-
  MgCa_subsampled_150 %>% 
ggplot()+
  aes(mean_dist,mean_mg_ca)+
  geom_path(col="firebrick2")

P3.2 <-
  MgCa_subsampled_300 %>% 
ggplot()+
  aes(mean_dist,mean_mg_ca)+
  geom_path(col="firebrick4")

P1/P3.1/P3.2

```

```{r}
# This is data extracted from Fig. 6E of Graniero et al. 2016
GranieroDF <- tibble::tribble(
                ~dist, ~mg_ca,
                  0.1,     19,
                  0.2,   20.6,
                  0.4,   23.8,
                  0.6,   20.4,
                    1,   19.1,
                  1.3,   14.9,
                  1.6,     16,
                  1.9,   17.8,
                  2.3,   15.8,
                  2.8,   17.3,
                  3.1,   13.8,
                  3.3,   24.9,
                  3.7,   16.1,
                    4,   15.6,
                  4.3,   18.4,
                  4.6,   15.5,
                  5.2,   18.6,
                  5.2,   21.2,
                  5.5,   24.1,
                  5.8,   18.7,
                  6.2,   19.3,
                  6.3,   15.5,
                  6.7,   16.7,
                  6.9,   15.3,
                  7.3,   17.9,
                  7.6,   13.7,
                    8,   11.8,
                  8.2,   16.2,
                  8.5,   18.1,
                  8.9,     18,
                  9.1,   19.7,
                  9.4,   20.8,
                  9.7,   19.6,
                   10,   22.2,
                 10.2,   20.2,
                 10.5,   19.3,
                 10.8,   22.8,
                 11.2,   18.7,
                 11.8,   22.1
                )

```

<!--# Maybe get the actual data from the image itself. -->
